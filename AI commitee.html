<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¤šæ™ºèƒ½ä½“é‡åŒ–æŠ•ç ”ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼ä¸æ’ç‰ˆ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; }

        /* æœç´¢åŒºåŸŸ */
        .search-box { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        input[type="text"] { padding: 12px; width: 300px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 24px; background-color: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }

        /* åŠ è½½åŠ¨ç”»æç¤º */
        #loading { text-align: center; display: none; margin-bottom: 20px; font-weight: bold; color: #e67e22; }

        /* ç»“æœå±•ç¤ºåŒºï¼ˆé»˜è®¤éšè—ï¼‰ */
        #results { display: none; }

        /* æœ€ç»ˆå†³ç­–å¡ç‰‡ */
        .decision-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 6px solid #2ecc71; }
        .decision-card h2 { margin-top: 0; color: #27ae60; }
        .pre-wrap { white-space: pre-wrap; font-family: inherit; line-height: 1.6; }

        /* å››å¤§éƒ¨é—¨æŠ¥å‘Šç½‘æ ¼å¸ƒå±€ */
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); gap: 20px; margin-bottom: 20px; }
        .report-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .report-card h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tech-title { color: #3498db; }
        .fund-title { color: #9b59b6; }
        .sent-title { color: #f39c12; }
        .risk-title { color: #e74c3c; }

        /* æ–°é—»é“¾æ¥åŒºåŸŸ */
        .news-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .news-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .news-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .news-title { font-weight: bold; font-size: 16px; color: #2c3e50; text-decoration: none; }
        .news-title:hover { text-decoration: underline; color: #3498db; }
        .news-meta { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .news-content { font-size: 14px; color: #555; margin-top: 8px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ¤– AI æŠ•ç ”å§”å‘˜ä¼šåˆ†æç³»ç»Ÿ</h1>

    <div class="search-box">
        <!-- ã€æ–°å¢è¿™è¡Œã€‘API Key å¯†ç è¾“å…¥æ¡† -->
        <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ API Key (sk-...)" style="padding: 12px; width: 200px; border: 1px solid #ccc; border-radius: 8px;" />

        <input type="text" id="tickerInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹: sh.600519)" />
        <button id="analyzeBtn" onclick="startAnalysis()">å¼€å§‹æ·±åº¦ç ”æŠ¥</button>
    </div>

    <div id="loading">
        â³ æŠ•ç ”å§”å‘˜ä¼šæ­£åœ¨å¼€ä¼šï¼Œçˆ¬è™«é›†ç¾¤ä¸å¤§æ¨¡å‹æ­£åœ¨æé€Ÿè¿è½¬ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾… (çº¦éœ€ 15-30 ç§’)...
    </div>

    <div id="results">

        <div class="decision-card">
            <h2>ğŸ† æŠ•èµ„å§”å‘˜ä¼šæœ€ç»ˆå†³è®®</h2>
            <div id="finalDecision" class="pre-wrap"></div>
            <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
                <button id="toggleDebateBtn" onclick="toggleDebate()" style="display: none; background-color: #f39c12; padding: 8px 16px; font-size: 14px;">
                    ğŸ“œ æŸ¥çœ‹ä¸‰è½®å¤šç©ºæ¿€è¾©è®°å½•
                </button>
                <div id="debateContent" class="pre-wrap" style="display: none; background: #fdfbf7; padding: 15px; border-left: 4px solid #f39c12; border-radius: 8px; margin-top: 10px;">
                    </div>
            </div>
        </div>

        <div class="reports-grid">
            <div class="report-card" style="grid-column: 1 / -1;">
                <h3 class="tech-title">ğŸ“ˆ æŠ€æœ¯é¢åˆ†æéƒ¨ (åŒ…å«è¿‘æœŸKçº¿èµ°åŠ¿)</h3>
                <div id="klineChart" style="width: 100%; height: 550px; display: none; margin-bottom: 20px;"></div>
                <div id="techReport" class="pre-wrap"></div>
            </div>
            <div class="report-card">
                <h3 class="fund-title">ğŸ“Š åŸºæœ¬é¢ç ”ç©¶éƒ¨</h3>
                <div id="fundReport" class="pre-wrap"></div>
            </div>
            <div class="report-card">
                <h3 class="sent-title">ğŸŒ å¸‚åœºæƒ…ç»ªä¸èˆ†æƒ…éƒ¨</h3>
                <div id="sentimentReport" class="pre-wrap"></div>
            </div>
            <div class="report-card">
                <h3 class="risk-title">ğŸ›¡ï¸ é¦–å¸­é£æ§å®˜ (CRO)</h3>
                <div id="riskReport" class="pre-wrap"></div>
            </div>
        </div>

        <div class="news-section">
            <h3 style="color: #34495e;">ğŸ“° å®šå‘æ–°é—»æƒ…æŠ¥ä¸æº¯æºé“¾æ¥</h3>
            <div id="newsContainer">
                </div>
        </div>

    </div>
</div>

<script>
    async function startAnalysis() {
        const ticker = document.getElementById('tickerInput').value.trim();
        const apiKey = document.getElementById('apiKeyInput').value.trim(); // ã€æ–°å¢ï¼šè·å–Keyã€‘

        if (!apiKey) {
            alert("è¯·è¾“å…¥ DeepSeek API Keyï¼"); // ã€æ–°å¢ï¼šæ£€æŸ¥Keyæ˜¯å¦ä¸ºç©ºã€‘
            return;
        }
        if (!ticker) {
            alert("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼");
            return;
        }


        // 1. åˆ‡æ¢ UI çŠ¶æ€ä¸ºâ€œåŠ è½½ä¸­â€
        const btn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        btn.disabled = true;
        btn.innerText = "åˆ†æä¸­...";
        loading.style.display = "block";
        results.style.display = "none"; // éšè—ä¸Šæ¬¡çš„ç»“æœ

        try {
            // 2. å‘ä½ çš„ Flask åç«¯å‘é€ POST è¯·æ±‚
            const response = await fetch('http://localhost:5000/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // ã€ä¿®æ”¹ç‚¹ï¼šæŠŠ api_key æ‹¼æ¥åˆ°å‚æ•°é‡Œå‘ç»™åç«¯ã€‘
                body: JSON.stringify({ ticker: ticker, api_key: apiKey })
            });

            const resData = await response.json();

            if (resData.status === 'success') {
                // 3. å¡«å……å››å¤§æŠ¥å‘Šå’Œæœ€ç»ˆå†³ç­–
                const debateText = resData.data.debate_history;
                const debateBtn = document.getElementById('toggleDebateBtn');
                const debateContent = document.getElementById('debateContent');

                if (debateText && debateText.trim() !== '') {
                    debateContent.innerText = debateText;
                    debateBtn.style.display = "inline-block"; // å¦‚æœæœ‰è¾©è®ºè®°å½•ï¼Œæ˜¾ç¤ºæŒ‰é’®
                    debateContent.style.display = "none";     // é»˜è®¤æ”¶èµ·çŠ¶æ€
                    debateBtn.innerText = "ğŸ“œ æŸ¥çœ‹ä¸‰è½®å¤šç©ºæ¿€è¾©è®°å½•"; // é‡ç½®æŒ‰é’®æ–‡å­—
                } else {
                    debateBtn.style.display = "none";
                }
                document.getElementById('finalDecision').innerText = resData.data.decision;
                document.getElementById('techReport').innerText = resData.data.reports.technical;
                document.getElementById('fundReport').innerText = resData.data.reports.fundamental;
                results.style.display = "block";
                if (resData.data.chart_data && resData.data.chart_data.length > 0) {
                    renderKLineChart(resData.data.chart_data);
                } else {
                    document.getElementById('klineChart').style.display = 'none';
                }
                document.getElementById('sentimentReport').innerText = resData.data.reports.sentiment;
                document.getElementById('riskReport').innerText = resData.data.reports.risk;

                // 4. åŠ¨æ€æ¸²æŸ“æ–°é—»é“¾æ¥åˆ—è¡¨
                const newsContainer = document.getElementById('newsContainer');
                newsContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„æ–°é—»

                if (resData.data.news_links && resData.data.news_links.length > 0) {
                    resData.data.news_links.forEach(news => {
                        // åˆ›å»ºå•æ¡æ–°é—»çš„ HTML ç»“æ„
                        const newsHTML = `
                            <div class="news-item">
                                <a href="${news.url}" target="_blank" class="news-title">${news.title} ğŸ”—</a>
                                <div class="news-meta">å‘å¸ƒæ—¶é—´: ${news.time}</div>
                                <div class="news-content">${news.content}</div>
                            </div>
                        `;
                        newsContainer.innerHTML += newsHTML;
                    });
                } else {
                    newsContainer.innerHTML = '<p style="color:#7f8c8d;">æœªè·å–åˆ°ç›¸å…³çš„å®šå‘æ–°é—»é“¾æ¥ã€‚</p>';
                }

                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                results.style.display = "block";
            } else {
                alert("åˆ†æå¤±è´¥ï¼š" + resData.message);
            }

        } catch (error) {
            console.error("è¯·æ±‚æŠ¥é”™:", error);
            alert("è¯·æ±‚åç«¯æœåŠ¡å¤±è´¥ï¼Œè¯·ç¡®ä¿ python app.py å·²å¯åŠ¨ï¼\né”™è¯¯ä¿¡æ¯: " + error.message);
        } finally {
            // 5. æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸è¿›è¡Œä¸‹ä¸€æ¬¡æŸ¥è¯¢
            btn.disabled = false;
            btn.innerText = "å¼€å§‹æ·±åº¦ç ”æŠ¥";
            loading.style.display = "none";
        }
    }
    function toggleDebate() {
        const content = document.getElementById('debateContent');
        const btn = document.getElementById('toggleDebateBtn');

        if (content.style.display === "none") {
            content.style.display = "block";
            btn.innerText = "æ”¶èµ·è¾©è®ºè®°å½• ğŸ”¼";
        } else {
            content.style.display = "none";
            btn.innerText = "ğŸ“œ æŸ¥çœ‹ä¸‰è½®å¤šç©ºæ¿€è¾©è®°å½• ğŸ”½";
        }
    }
    // ã€æ–°å¢ã€‘ç»˜åˆ¶ K çº¿å›¾çš„æ ¸å¿ƒå‡½æ•°
    function renderKLineChart(chartData) {
        const chartDom = document.getElementById('klineChart');
        chartDom.style.display = 'block'; // è®©å›¾è¡¨å®¹å™¨æ˜¾ç¤ºå‡ºæ¥
        const myChart = echarts.init(chartDom);

        // æ‹†è§£åç«¯ä¼ æ¥çš„æ•°æ®ï¼Œåˆ†åˆ«æ”¾è¿›ä¸åŒçš„æ•°ç»„é‡Œ
        const categoryData = [];
        const values = [];
        const ma5 = [];
        const ma20 = [];

        chartData.forEach(item => {
            categoryData.push(item.date);
            // ECharts è¦æ±‚çš„æ•°æ®é¡ºåºæ˜¯ï¼š[å¼€ç›˜ä»·, æ”¶ç›˜ä»·, æœ€ä½ä»·, æœ€é«˜ä»·]
            values.push([item.open, item.close, item.low, item.high]);
            ma5.push(item.MA5);
            ma20.push(item.MA20);
        });

        // ECharts çš„é…ç½®é¡¹
        const option = {
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { data: ['æ—¥K', 'MA5', 'MA20'] },
            grid: { left: '10%', right: '10%', bottom: '15%' },
            xAxis: {
                type: 'category',
                data: categoryData,
                scale: true,
                boundaryGap: false,
                axisLine: { onZero: false },
                splitLine: { show: false }
            },
            yAxis: { scale: true, splitArea: { show: true } },
            // æ·»åŠ åº•éƒ¨å¯ç¼©æ”¾çš„æ»šåŠ¨æ¡
            dataZoom: [
                { type: 'inside', start: 60, end: 100 },
                { show: true, type: 'slider', top: '90%', start: 60, end: 100 }
            ],
            series: [
                {
                    name: 'æ—¥K',
                    type: 'candlestick',
                    data: values,
                    // çº¢è‰²ä¸Šæ¶¨ï¼Œç»¿è‰²ä¸‹è·Œ (ç¬¦åˆAè‚¡ä¹ æƒ¯)
                    itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' }
                },
                {
                    name: 'MA5', type: 'line', data: ma5, smooth: true, lineStyle: { opacity: 0.5 }
                },
                {
                    name: 'MA20', type: 'line', data: ma20, smooth: true, lineStyle: { opacity: 0.5 }
                }
            ]
        };
        myChart.setOption(option);
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }
</script>

</body>
</html>